## 0 简介

> 在摊还分析中，我们求数据结构的**一个操作序列中所执行的所有操作的平均时间**，来评价操作的代价。这样，我们就可以说明一个操作的评价代价是很低的，即使序列中某个单一的操作的代价很高。摊还分析不同于平均情况分析，它并不涉及概率，它可以保证最坏情况下每个操作的平均性能。
>
> 摊还分析中最常用的三种技术是：**聚合分析**，**核能法**和**势能法**。

## 1 聚合分析

利用聚合分析，我们证明对所有 $n$，一个 $n$ 个操作的序列最坏情况下话费的总时间为 $T(n)$。因此，在最坏情况下每个操作的平均代价，或**摊还代价**为 $T(n)/n$。

**实例1：栈操作**

一个栈操作序列中包含3种操作：$PUSH$，$POP$ 和 $MULTIPOP$，其中 MULTIPOP 操作可以一次将多个元素弹出，求这个栈操作序列的摊还代价。

在分析最坏情况代价时，可能会得到这样的结果，$MULTIPOP$ 操作的最坏情况时间为 $O(n)$，而最多可能有 $n$ 个 $MULTIPOP$ 操作，所以最坏情况代价为 $O(n^2)$。

然而进一步分析会发现这个代价不是紧确的，还可以得到更低的最坏情况代价。再分析一下栈的性质会发现：当将一个对象压入栈后，我们至多将其弹出一次。一次，对于一个非空的栈，可以执行的 $POP$ 操作的次数(包括了 $MULTIPOP$ 中调用 $POP$ 的次数) 最多与 PUSH 操作的次数相当，即最多 $n$ 次。因此，对任意的 $n$ 值，任意一个由 $n$ 个 $PUSH$、$POP$ 和 $MULTIPOP$ 组成的操作序列，最多花费 $O(n)$ 时间。一个操作的平均时间为 $O(n)/n = O(1)$。**在聚合分析中，我们将每个操作的摊还代价设定为平均代价**。因此，在此例中，所有三种栈操作的摊还代价都是 $O(1)$。

**实例2：二进制计数器**

用一个 $k$ 位二进制数 $A$ 进行计数，从 0 开始累加到 $n$，求 $A$ 的翻转[^1]次数的摊还代价。

粗略分析可以得到每次计数器累加， A 的翻转次数为 $\Theta(k)$，所以最坏情况下 n 次累加得到总的翻转次数为 $\Theta(kn)$，但是这个代价也不是紧确的。下图是进行16次计数的翻转次数统计：

![CountTo16](../static/image/CountTo16.png)

可以看到翻转次数不会超过 $2n$。原因是 $A$ 中除了最低位每次都会翻转，其他位要累加多次才会进行翻转，例如从低位数第2位要累加2次才翻转，第3位要累加4次才翻转，第 $i$ 位要累加 $2^{i-1}$ 次才翻转。根据附录 A 中的公式6(A.6)，可以计算出累加 $n$ 次的翻转次数为：

$\sum\limits_{i=0}^{k-1}\lfloor \frac{n}{2^i}\rfloor < n\sum\limits_{i=0}^{\infty}\frac{1}{2^i} = 2n$

所以 $n$ 次累加操作在最坏情况下 $A$ 的翻转次数为 $\Omicron(n)$，每个操作的平均代价，即摊还代价为 $\Omicron(n)/n=\Omicron(1)$。



[^1]: 当 $A$ 中的某一位从 0 变为 1，或从 1 变为 0 时，表示 1 次翻转

